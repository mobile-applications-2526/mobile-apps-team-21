<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WS Test Client</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px; }
    input, button { padding: 8px; margin: 4px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow: auto; padding: 8px; }
    .msg { margin-bottom: 8px; padding:6px; border-bottom:1px solid #eee }
  </style>
</head>
<body>
  <h2>WebSocket / STOMP Test Client</h2>

  <section>
    <h3>Login (REST)</h3>
    <label>Email: <input id="email" value="john.smith@example.com"></label>
    <label>Password: <input id="password" type="password" value="password123"></label>
    <button id="btnLogin">Login & Get JWT</button>
    <div>Token: <code id="tokenOut">(none)</code></div>
  </section>

  <section>
    <h3>Connection</h3>
    <label>Server URL: <input id="serverUrl" value="http://localhost:8080" style="width:350px"></label>
    <label>Group name: <input id="groupName" value="Avondeten"></label>
    <label>Group id: <input id="groupId" value="691e2134bebb656f66c5464f"></label>
    <br>
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>
    <button id="btnJoin" disabled>Send Join</button>
  </section>

  <section>
    <h3>Chat</h3>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Type message..." style="width:70%">
    <button id="btnSend" disabled>Send</button>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs/bundles/stomp.umd.min.js"></script>
  <script>
    const SockJS = window.SockJS;
    const StompLib = window.Stomp || window.StompJs || window.StompJS || window.stompjs || window.StompClient;

    let client = null;
    let subscription = null;
    let userSubscription = null;
    let jwt = null;
    let connectionType = null;

    document.getElementById('btnLogin').addEventListener('click', async () => {
      const server = document.getElementById('serverUrl').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(server + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) throw new Error('Login failed: ' + res.status);
        const json = await res.json();
        jwt = json.token;
        document.getElementById('tokenOut').textContent = jwt;
        alert('Login OK');
      } catch (err) {
        alert('Login error: ' + err);
      }
    });

    document.getElementById('btnConnect').addEventListener('click', () => {
      const server = document.getElementById('serverUrl').value.replace(/\/$/, '');
      const group = document.getElementById('groupName').value;
      if (!jwt) { alert('Get a token first via Login'); return; }

      // pass token as query param so handshake interceptor can store it for STOMP auth
      const sock = new SockJS(server + '/ws?token=' + encodeURIComponent(jwt));
      function onConnectFrame(frame) {
        console.log('connected', frame);
        document.getElementById('btnConnect').disabled = true;
        document.getElementById('btnDisconnect').disabled = false;
        document.getElementById('btnSend').disabled = false;
        document.getElementById('btnJoin').disabled = false;

        // subscribe to group topic
        subscription = client.subscribe('/topic/groups/' + group, (msg) => { handleIncoming(msg); });
        // subscribe to user-specific history queue so this joining user receives prior messages only for them
        try {
          userSubscription = client.subscribe('/user/queue/groups/' + group + '/history', (msg) => { handleIncoming(msg); });
        } catch(err) { console.warn('history subscription failed', err); }

        // announce join (optional)
        try {
          if (connectionType === 'legacy') client.send('/app/groups/' + group + '/join', {}, '');
          else client.publish({ destination: '/app/groups/' + group + '/join', body: '' });
        } catch(e) { console.warn(e); }
      }

      function handleIncoming(msg) {
        let parsed;
        try { parsed = JSON.parse(msg.body); } catch(e) { parsed = msg.body; }
        if (Array.isArray(parsed)) parsed.forEach(appendMessage);
        else appendMessage(parsed);
      }

      function onError(err) {
        console.error('STOMP error', err);
        alert('STOMP ERROR: ' + JSON.stringify(err));
      }

      if (StompLib && typeof StompLib.over === 'function') {
        // legacy UMD exposes `Stomp.over`
        client = StompLib.over(sock);
        client.debug = (msg) => console.log('STOMP:', msg);
        connectionType = 'legacy';
        client.connect({ Authorization: 'Bearer ' + jwt }, onConnectFrame, onError);
      } else if (StompLib && typeof StompLib.Client === 'function') {
        // modern API (StompJs.Client)
        client = new StompLib.Client({
          webSocketFactory: () => sock,
          connectHeaders: { Authorization: 'Bearer ' + jwt },
          onConnect: onConnectFrame,
          onStompError: onError
        });
        connectionType = 'new';
        client.activate();
      } else {
        alert('STOMP library not found in page. Check that stomp.umd.min.js is loaded.');
        return;
      }
    });

    document.getElementById('btnDisconnect').addEventListener('click', () => {
      if (client) {
        try { if (connectionType === 'legacy') client.disconnect(); else client.deactivate(); } catch(e) { console.warn(e); }
      }
      document.getElementById('btnConnect').disabled = false;
      document.getElementById('btnDisconnect').disabled = true;
      document.getElementById('btnSend').disabled = true;
      document.getElementById('btnJoin').disabled = true;
      subscription = null;
    });

    document.getElementById('btnSend').addEventListener('click', () => {
      const group = document.getElementById('groupName').value;
      const groupId = document.getElementById('groupId').value;
      const email = document.getElementById('email').value;
      const content = document.getElementById('messageInput').value;
      if (!client) return alert('Not connected');
      if (connectionType === 'legacy' && !client.connected) return alert('Not connected');
      if (connectionType === 'new' && !client.active) return alert('Not connected');
      const payload = { content, senderEmail: email, groupId };
      try {
        if (connectionType === 'legacy') client.send('/app/groups/' + group + '/send', {}, JSON.stringify(payload));
        else client.publish({ destination: '/app/groups/' + group + '/send', body: JSON.stringify(payload) });
      } catch(e) { console.warn(e); }
      document.getElementById('messageInput').value = '';
    });

    document.getElementById('btnJoin').addEventListener('click', () => {
      const group = document.getElementById('groupName').value;
      if (!client) return alert('Not connected');
      if (connectionType === 'legacy' && !client.connected) return alert('Not connected');
      if (connectionType === 'new' && !client.active) return alert('Not connected');
      try { if (connectionType === 'legacy') client.send('/app/groups/' + group + '/join', {}, ''); else client.publish({ destination: '/app/groups/' + group + '/join', body: '' }); } catch(e) { console.warn(e); }
    });

    function appendMessage(m) {
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'msg';
      const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString() : '';
      div.textContent = `[${time}] ${m.authorId ?? m.senderEmail ?? 'unknown'}: ${m.content ?? JSON.stringify(m)}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }
  </script>
</body>
</html>